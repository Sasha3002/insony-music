{% extends "users/base.html" %}
{% load rating_tags %}
{% load static %}
{% block content %}
<div class="container mt-4">

  <div class="d-flex flex-wrap justify-content-between align-items-center gap-3 mb-3">
    <h2 class="mb-0 text-white">ğŸµ Biblioteka utworÃ³w</h2>

    <!-- WYSZUKIWARKA â€“ wariant "pill" -->
    <form method="get" class="insony-search" role="search">
      {% if sort %}<input type="hidden" name="sort" value="{{ sort }}">{% endif %}

      <span class="search-icon" aria-hidden="true">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
          <path d="M21 21l-4.3-4.3" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
          <circle cx="11" cy="11" r="7" stroke="currentColor" stroke-width="2"/>
        </svg>
      </span>

      <input
        type="search"
        name="q"
        class="search-input"
        placeholder="Szukaj: tytuÅ‚, wykonawca, gatunek"
        value="{{ q }}"
        aria-label="Pole wyszukiwania utworÃ³w"
        autocomplete="off"
      />

      {% if q %}
        <button class="clear-btn" type="button" aria-label="WyczyÅ›Ä‡" title="WyczyÅ›Ä‡">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none">
            <path d="M18 6L6 18M6 6l12 12" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
          </svg>
        </button>
      {% endif %}

      <button class="submit-btn" type="submit" aria-label="Szukaj" title="Szukaj">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none">
          <path d="M21 21l-4.3-4.3" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
          <circle cx="11" cy="11" r="7" stroke="currentColor" stroke-width="2"/>
        </svg>
      </button>
    </form>

    <!-- Sortowanie -->
    <div class="dropdown ms-auto">
      <button class="btn btn-sm btn-outline-light dropdown-toggle" type="button" data-bs-toggle="dropdown">
        Sortuj
      </button>
      <ul class="dropdown-menu dropdown-menu-dark dropdown-menu-end">
        <li class="dropdown-header">Podstawowe</li>
        <li><a class="dropdown-item {% if sort == 'custom' %}active{% endif %}" href="?sort=custom{% if q %}&q={{ q|urlencode }}{% endif %}">SwÃ³j porzÄ…dek</a></li>
        <li><a class="dropdown-item {% if sort == 'date' %}active{% endif %}" href="?sort=date{% if q %}&q={{ q|urlencode }}{% endif %}">Po dacie dodania (najnowsze)</a></li>
        <li><a class="dropdown-item {% if sort == 'date_asc' %}active{% endif %}" href="?sort=date_asc{% if q %}&q={{ q|urlencode }}{% endif %}">Po dacie dodania (najstarsze)</a></li>
        <li><hr class="dropdown-divider"></li>
        <li class="dropdown-header">Tekstowe</li>
        <li><a class="dropdown-item {% if sort == 'title' %}active{% endif %}" href="?sort=title{% if q %}&q={{ q|urlencode }}{% endif %}">TytuÅ‚ Aâ†’Z</a></li>
        <li><a class="dropdown-item {% if sort == 'title_desc' %}active{% endif %}" href="?sort=title_desc{% if q %}&q={{ q|urlencode }}{% endif %}">TytuÅ‚ Zâ†’A</a></li>
        <li><a class="dropdown-item {% if sort == 'artist' %}active{% endif %}" href="?sort=artist{% if q %}&q={{ q|urlencode }}{% endif %}">Wykonawca Aâ†’Z</a></li>
        <li><a class="dropdown-item {% if sort == 'artist_desc' %}active{% endif %}" href="?sort=artist_desc{% if q %}&q={{ q|urlencode }}{% endif %}">Wykonawca Zâ†’A</a></li>
        <li><a class="dropdown-item {% if sort == 'genre' %}active{% endif %}" href="?sort=genre{% if q %}&q={{ q|urlencode }}{% endif %}">Gatunek Aâ†’Z</a></li>
        <li><a class="dropdown-item {% if sort == 'genre_desc' %}active{% endif %}" href="?sort=genre_desc{% if q %}&q={{ q|urlencode }}{% endif %}">Gatunek Zâ†’A</a></li>
        <li><hr class="dropdown-divider"></li>
        <li class="dropdown-header">Oceny</li>
        <li><a class="dropdown-item {% if sort == 'rating_high' %}active{% endif %}" href="?sort=rating_high{% if q %}&q={{ q|urlencode }}{% endif %}">NajwyÅ¼sza ocena</a></li>
        <li><a class="dropdown-item {% if sort == 'rating_low' %}active{% endif %}" href="?sort=rating_low{% if q %}&q={{ q|urlencode }}{% endif %}">NajniÅ¼sza ocena</a></li>
        <li><a class="dropdown-item {% if sort == 'reviews' %}active{% endif %}" href="?sort=reviews{% if q %}&q={{ q|urlencode }}{% endif %}">NajwiÄ™cej recenzji</a></li>
      </ul>
    </div>
  </div>

  {% if q %}
    <p class="text-muted small mb-2">Wyniki dla: <strong>â€{{ q }}â€</strong></p>
  {% endif %}

  {% if tracks %}
  <div class="insony-table list-group list-group-flush rounded-3 overflow-hidden">

    <!-- nagÅ‚Ã³wek -->
    <div class="insony-row insony-head">
      <div class="col-idx">#</div>
      <div class="col-title">Nazwa</div>
      <div class="col-artist d-none d-md-block">Wykonawca</div>
      <div class="col-genre d-none d-lg-block">Gatunek</div>
      <div class="col-authored d-none d-lg-block">Data utworu</div> 
      <div class="col-duration d-none d-md-block">Czas</div>
      <div class="col-rating">Åšrednia</div>
    </div>

    <!-- wiersze -->
    {% for track in tracks %}
    <div class="insony-row">
      <div class="col-idx">{{ forloop.counter }}</div>

      <div class="col-title">
        <div class="cover">
          {% if track.cover_image %}
            <img src="{{ track.cover_image }}" alt="{{ track.title }}" style="width: 100%; height: 100%; object-fit: cover; border-radius: 4px;">
          {% else %}
            <img src="{% static 'img/Insony.jpg' %}" alt="Insony" style="width: 100%; height: 100%; object-fit: cover; border-radius: 4px;">
          {% endif %}
        </div>
        <div class="meta">
          <a href="{% url 'track_detail' track.id %}" class="title-link">{{ track.title }}</a>
          <div class="muted d-md-none">{{ track.artist.name }}</div>
        </div>
      </div>

      <div class="col-artist d-none d-md-block text-truncate">{{ track.artist.name }}</div>
      <div class="col-genre d-none d-lg-block text-truncate">
        {% if track.genre %}{{ track.genre.name }}{% else %}â€”{% endif %}
      </div>
      <!---<div class="col-date d-none d-md-block">{{ track.created_at|date:"d.m.Y" }}</div> -->
      <div class="col-authored d-none d-lg-block">{{ track.authored_date|date:"d.m.Y"|default:"â€”" }}</div> <!-- âœ… -->
      <div class="col-duration d-none d-md-block">{{ track.duration_display }}</div>

      <div class="col-rating" style="min-width:120px;">
        {% if track.avg %}
          <div class="d-flex align-items-center gap-1">
            <strong>{{ track.avg|floatformat:0 }}</strong><span class="muted">/100</span>
          </div>
          <div class="progress mt-1" style="height:4px;">
            <div class="progress-bar" style="width: {{ track.avg|floatformat:0 }}%;"></div>
          </div>
        {% else %}
          <span class="muted">Brak</span>
        {% endif %}
      </div>

      
    </div>
    {% endfor %}

  </div>
    <!-- pagination -->
  <nav class="mt-3">
    <ul class="pagination pagination-sm mb-0 justify-content-center">
      <li class="page-item {% if not tracks.has_previous %}disabled{% endif %}">
        {% if tracks.has_previous %}
          <a class="page-link" href="?sort={{ sort }}{% if q %}&q={{ q|urlencode }}{% endif %}&page=1">Â«</a>
        {% else %}
          <span class="page-link">Â«</span>
        {% endif %}
      </li>

      <li class="page-item {% if not tracks.has_previous %}disabled{% endif %}">
        {% if tracks.has_previous %}
          <a class="page-link" href="?sort={{ sort }}{% if q %}&q={{ q|urlencode }}{% endif %}&page={{ tracks.previous_page_number }}">â€¹</a>
        {% else %}
          <span class="page-link">â€¹</span>
        {% endif %}
      </li>

      <li class="page-item active">
        <span class="page-link">{{ tracks.number }} / {{ tracks.paginator.num_pages }}</span>
      </li>

      <li class="page-item {% if not tracks.has_next %}disabled{% endif %}">
        {% if tracks.has_next %}
          <a class="page-link" href="?sort={{ sort }}{% if q %}&q={{ q|urlencode }}{% endif %}&page={{ tracks.next_page_number }}">â€º</a>
        {% else %}
          <span class="page-link">â€º</span>
        {% endif %}
      </li>

      <li class="page-item {% if not tracks.has_next %}disabled{% endif %}">
        {% if tracks.has_next %}
          <a class="page-link" href="?sort={{ sort }}{% if q %}&q={{ q|urlencode }}{% endif %}&page={{ tracks.paginator.num_pages }}">Â»</a>
        {% else %}
          <span class="page-link">Â»</span>
        {% endif %}
      </li>
    </ul>
  </nav>

  {% else %}
    <div class="alert alert-secondary text-center mt-4">Brak utworÃ³w do wyÅ›wietlenia.</div>
  {% endif %}
</div>

<!-- mini skrypt do dziaÅ‚ania przycisku â€WyczyÅ›Ä‡â€ -->
<script>
  const clearBtn = document.querySelector('.insony-search .clear-btn');
  if (clearBtn) {
    clearBtn.addEventListener('click', () => {
      const form = clearBtn.closest('form');
      const input = form.querySelector('.search-input');
      input.value = '';
      form.submit();
    });
  }
</script>
{% endblock %}
