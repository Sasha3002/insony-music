{% extends "users/base.html" %}
{% load static %}

{% block extra_css %}
  <link rel="stylesheet" href="{% static 'css/chat.css' %}">
{% endblock %}

{% block content %}



<div class="container py-4">
  
  <div class="chat-list-header">
    <h1 class="chat-list-title">
      <i class="bi bi-chat-dots"></i>
      Wiadomości
    </h1>
    <p class="chat-list-subtitle">Twoje prywatne rozmowy</p>
  </div>

  {% if conversations %}
    {% for conversation in conversations %}
      <a href="{% url 'conversation_detail' conversation.id %}" class="conversation-card {% if conversation.unread_count > 0 %}has-unread{% endif %}">
          <div class="conversation-avatar">
            {% if conversation.other_user.profile_picture %}
              <img src="{{ conversation.other_user.profile_picture.url }}" alt="{{ conversation.other_user.username }}">
            {% else %}
              <div class="avatar-placeholder">
                {{ conversation.other_user.username|slice:":1"|upper }}
              </div>
            {% endif %}
          </div>

          <div class="conversation-info">
            <div class="conversation-user">{{ conversation.other_user.username }}</div>
            <div class="conversation-preview">
              {% if conversation.last_message %}
                {% if conversation.last_message.sender == request.user %}Ty: {% endif %}
                {{ conversation.last_message.content|truncatechars:50 }}
              {% else %}
                Rozpocznij rozmowę...
              {% endif %}
            </div>
          </div>

          <div class="conversation-meta">
            {% if conversation.unread_count > 0 %}
              <div class="unread-badge">{{ conversation.unread_count }}</div>
            {% endif %}
            {% if conversation.last_message %}
              <div class="conversation-time">{{ conversation.last_message.created_at|date:"H:i" }}</div>
            {% endif %}
          </div>
        </a>
    {% endfor %}
  {% else %}
    <div class="chat-empty-state">
      <i class="bi bi-chat-dots chat-empty-state-icon"></i>
      <h3 class="chat-empty-state-title">Nie masz jeszcze żadnych rozmów</h3>
      <p>Odwiedź profil innego użytkownika i rozpocznij rozmowę</p>
      <a href="{% url 'user_search' %}" class="btn btn-primary">
        <i class="bi bi-search"></i> Znajdź użytkowników
      </a>
    </div>
  {% endif %}

</div>

<script>
function updateUnreadCounts() {
  fetch('{% url "get_unread_counts" %}')
    .then(response => response.json())
    .then(data => {
      if (data.ok) {
        data.conversations.forEach(conv => {
          const card = document.querySelector(`a[href*="conversation/${conv.conversation_id}/"]`);
          if (!card) return;
          const metaDiv = card.querySelector('.conversation-meta');
          const previewDiv = card.querySelector('.conversation-preview');
          const timeDiv = card.querySelector('.conversation-time');
          const oldBadge = metaDiv.querySelector('.unread-badge');
          if (oldBadge) oldBadge.remove();
          
          if (conv.unread_count > 0) {
            const badge = document.createElement('div');
            badge.className = 'unread-badge';
            badge.textContent = conv.unread_count;
            metaDiv.insertBefore(badge, metaDiv.firstChild);
            card.classList.add('has-unread');
          } else {
            card.classList.remove('has-unread');
          }
          if (conv.last_message) {
            const prefix = conv.last_message.is_own ? 'Ty: ' : '';
            const truncated = conv.last_message.content.substring(0, 47);
            const display = truncated.length < conv.last_message.content.length 
              ? truncated + '...' 
              : truncated;
            previewDiv.textContent = prefix + display;
            if (timeDiv) {
              timeDiv.textContent = conv.last_message.time;
            }
          }
        });
      }
    })
    .catch(error => console.error('Polling error:', error));
}

setInterval(updateUnreadCounts, 5000);
</script>

{% endblock %}