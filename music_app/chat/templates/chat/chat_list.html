{% extends "users/base.html" %}
{% load static %}

{% block extra_css %}
  <link rel="stylesheet" href="{% static 'css/chat.css' %}">
{% endblock %}

{% block content %}


<div id="chatListPage"></div>
<div class="container py-4">
  
  <div class="chat-list-header">
    <h1 class="chat-list-title">
      <i class="bi bi-chat-dots"></i>
      Wiadomości
    </h1>
    <p class="chat-list-subtitle">Twoje prywatne rozmowy</p>
  </div>

  {% if conversations %}
    {% for conversation in conversations %}
      <a href="{% url 'conversation_detail' conversation.id %}" class="conversation-card {% if conversation.unread_count > 0 %}has-unread{% endif %}">
          <div class="conversation-avatar">
            {% if conversation.other_user.profile_picture %}
              <img src="{{ conversation.other_user.profile_picture.url }}" alt="{{ conversation.other_user.username }}">
            {% else %}
              <div class="avatar-placeholder">
                {{ conversation.other_user.username|slice:":1"|upper }}
              </div>
            {% endif %}
          </div>

          <div class="conversation-info">
            <div class="conversation-user">{{ conversation.other_user.username }}</div>
            <div class="conversation-preview">
              {% if conversation.last_message %}
                {% if conversation.last_message.sender == request.user %}Ty: {% endif %}
                {{ conversation.last_message.content|truncatechars:50 }}
              {% else %}
                Rozpocznij rozmowę...
              {% endif %}
            </div>
          </div>

          <div class="conversation-meta">
            {% if conversation.unread_count > 0 %}
              <div class="unread-badge">{{ conversation.unread_count }}</div>
            {% endif %}
            {% if conversation.last_message %}
              <div class="conversation-time">{{ conversation.last_message.created_at|date:"H:i" }}</div>
            {% endif %}
          </div>
        </a>
    {% endfor %}
  {% else %}
    <div class="chat-empty-state">
      <i class="bi bi-chat-dots chat-empty-state-icon"></i>
      <h3 class="chat-empty-state-title">Nie masz jeszcze żadnych rozmów</h3>
      <p>Odwiedź profil innego użytkownika i rozpocznij rozmowę</p>
      <a href="{% url 'user_search' %}" class="btn btn-primary">
        <i class="bi bi-search"></i> Znajdź użytkowników
      </a>
    </div>
  {% endif %}

</div>

<input type="hidden" id="unreadCountsUrl" value="{% url 'get_unread_counts' %}">

{% endblock %}

{% block extra_js %}
  <script src="{% static 'js/chat.js' %}"></script>
{% endblock %}