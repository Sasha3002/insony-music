{% extends "users/base.html" %}
{% load static %}

{% block extra_css %}
  <link rel="stylesheet" href="{% static 'css/users.css' %}">
{% endblock %}

{% block content %}

<div class="container py-4">
  
  <!-- Page Hero -->
  <div class="edit-hero">
    <h1 class="page-title-edit">
      <i class="bi bi-pencil-square"></i>
      Edytuj profil
    </h1>
    <p class="page-subtitle">Zaktualizuj swoje informacje i preferencje muzyczne</p>
  </div>

  <form method="POST" enctype="multipart/form-data" class="form-card">
    {% csrf_token %}

    <!-- Avatar Section -->
    <div class="avatar-section">
      <div class="avatar-preview" id="avatar-preview">
        {% if user.profile_picture %}
          <img src="{{ user.profile_picture.url }}" alt="{{ user.username }}" style="width: 100%; height: 100%; object-fit: cover; border-radius: 50%;">
        {% else %}
          {{ user.username|slice:":1"|upper }}
        {% endif %}
      </div>
      <div class="avatar-info" style="flex: 1;">
        <h4>{{ user.username }}</h4>
        <p>Dołączył {{ user.date_joined|date:"d F Y" }}</p>
        
        <div style="margin-top: 12px;">
          <label for="picture-upload" class="btn-upload">
            <i class="bi bi-camera"></i>
            Zmień zdjęcie
          </label>
          <input 
            type="file" 
            id="picture-upload" 
            name="profile_picture" 
            accept="image/*"
            style="display: none;">
          
          {% if user.profile_picture %}
          <button type="button" class="btn-remove-picture" id="remove-picture">
            <i class="bi bi-trash"></i>
            Usuń zdjęcie
          </button>
          {% endif %}
        </div>
      </div>
    </div>

    <!-- Personal Information Section -->
    <div class="form-section-title">
      <i class="bi bi-person"></i>
      Informacje osobiste
    </div>

    <div class="form-grid">
      <div class="form-group">
        <label class="form-label-modern">Imię</label>
        <input 
          type="text" 
          class="form-control-modern" 
          name="first_name" 
          value="{{ first_name }}"
          placeholder="Twoje imię">
      </div>

      <div class="form-group">
        <label class="form-label-modern">Nazwisko</label>
        <input 
          type="text" 
          class="form-control-modern" 
          name="last_name" 
          value="{{ last_name }}"
          placeholder="Twoje nazwisko">
      </div>

      <div class="form-group form-grid-full">
        <label class="form-label-modern">Email</label>
        <input 
          type="email" 
          class="form-control-modern" 
          name="email" 
          value="{{ email }}" 
          required
          placeholder="twoj@email.com">
        <div class="form-text-modern">
          <i class="bi bi-info-circle"></i>
          Używany do logowania i powiadomień
        </div>
      </div>

      <div class="form-group form-grid-full">
        <label class="form-label-modern">
          <i class="bi bi-geo-alt"></i> Miasto
        </label>
        <input 
          type="text" 
          class="form-control-modern" 
          name="city" 
          value="{{ city|default:'' }}"
          placeholder="np. Warszawa, Kraków, Online..."
          maxlength="200">
        <div class="form-text-modern">
          <i class="bi bi-info-circle"></i>
          Twoje miasto zamieszkania (opcjonalne)
        </div>
      </div>
    </div>

    <!-- Music Preferences Section -->
    <div class="form-section-title" style="margin-top: 32px;">
      <i class="bi bi-music-note-beamed"></i>
      Preferencje muzyczne
    </div>

    <div class="form-grid">
      <!-- Genres Autocomplete -->
      <div class="form-group form-grid-full">
        <label class="form-label-modern">Ulubione gatunki</label>
        <div class="autocomplete-wrapper">
          <input 
            type="text" 
            class="form-control-modern" 
            id="genres-search"
            placeholder="Zacznij pisać aby wyszukać gatunek..."
            autocomplete="off">
          <div class="autocomplete-dropdown" id="genres-dropdown"></div>
        </div>
        <div class="form-text-modern">
          <i class="bi bi-info-circle"></i>
          Wpisz nazwę gatunku i wybierz z listy
        </div>
        
        <!-- Selected Tags -->
        <div class="selected-tags" id="genres-tags"></div>
        
        <!-- Hidden input for form submission -->
        <input type="hidden" name="favorite_genres" id="genres-hidden" value="{{ favorite_genres }}">
      </div>

      <!-- Artists Autocomplete -->
      <div class="form-group form-grid-full">
        <label class="form-label-modern">Ulubieni artyści</label>
        <div class="autocomplete-wrapper">
          <input 
            type="text" 
            class="form-control-modern" 
            id="artists-search"
            placeholder="Zacznij pisać aby wyszukać artystę..."
            autocomplete="off">
          <div class="autocomplete-dropdown" id="artists-dropdown"></div>
        </div>
        <div class="form-text-modern">
          <i class="bi bi-info-circle"></i>
          Wpisz nazwę artysty i wybierz z listy
        </div>
        
        <!-- Selected Tags -->
        <div class="selected-tags" id="artists-tags"></div>
        
        <!-- Hidden input for form submission -->
        <input type="hidden" name="favorite_artists" id="artists-hidden" value="{{ favorite_artists }}">
      </div>
    </div>

    <!-- Bio Section -->
    <div class="form-section-title" style="margin-top: 32px;">
      <i class="bi bi-chat-quote"></i>
      O mnie
    </div>

    

    <div class="form-group">
      <label class="form-label-modern">Bio</label>
      <textarea 
        class="form-control-modern" 
        name="bio" 
        id="bio-input"
        rows="5"
        maxlength="500"
        placeholder="Opowiedz coś o sobie i swoich muzycznych pasjach...">{{ bio }}</textarea>
      <div class="char-counter">
        <span id="bio-count">0</span> / 500 znaków
      </div>
    </div>

    <!-- Action Buttons -->
    <div class="action-buttons">
      <a class="btn-cancel" href="{% url 'profile' %}">
        <i class="bi bi-x-circle"></i>
        Anuluj
      </a>
      <button type="submit" class="btn-save">
        <i class="bi bi-check-circle"></i>
        Zapisz zmiany
      </button>
    </div>

  </form>
</div>

<script>
(function() {
  // Get all genres and artists from Django context
  const allGenres = [
    {% for genre in all_genres %}
      "{{ genre.name|escapejs }}"{% if not forloop.last %},{% endif %}
    {% endfor %}
  ];
  
  const allArtists = [
    {% for artist in all_artists %}
      "{{ artist.name|escapejs }}"{% if not forloop.last %},{% endif %}
    {% endfor %}
  ];

  // Initialize selected items from current values
  const currentGenres = "{{ favorite_genres|escapejs }}".split(',').map(g => g.trim()).filter(g => g);
  const currentArtists = "{{ favorite_artists|escapejs }}".split(',').map(a => a.trim()).filter(a => a);

  // Generic autocomplete class
  class Autocomplete {
    constructor(inputId, dropdownId, tagsId, hiddenId, allItems, icon) {
      this.input = document.getElementById(inputId);
      this.dropdown = document.getElementById(dropdownId);
      this.tagsContainer = document.getElementById(tagsId);
      this.hiddenInput = document.getElementById(hiddenId);
      this.allItems = allItems;
      this.icon = icon;
      this.selectedItems = [];
      
      this.init();
    }

    init() {
      // Load initial selected items
      const initialValue = this.hiddenInput.value;
      if (initialValue) {
        this.selectedItems = initialValue.split(',').map(i => i.trim()).filter(i => i);
        this.renderTags();
      }

      // Input events
      this.input.addEventListener('input', () => this.handleInput());
      this.input.addEventListener('focus', () => this.handleInput());
      
      // Click outside to close
      document.addEventListener('click', (e) => {
        if (!this.input.contains(e.target) && !this.dropdown.contains(e.target)) {
          this.dropdown.classList.remove('show');
        }
      });
    }

    handleInput() {
      const query = this.input.value.trim().toLowerCase();
      
      if (query.length === 0) {
        this.dropdown.classList.remove('show');
        return;
      }

      // Filter items
      const filtered = this.allItems.filter(item => 
        item.toLowerCase().includes(query) && !this.selectedItems.includes(item)
      );

      this.renderDropdown(filtered);
    }

    renderDropdown(items) {
      if (items.length === 0) {
        this.dropdown.innerHTML = '<div class="autocomplete-empty">Nie znaleziono wyników</div>';
        this.dropdown.classList.add('show');
        return;
      }

      this.dropdown.innerHTML = items.slice(0, 10).map(item => `
        <div class="autocomplete-item" data-value="${item}">
          <i class="bi ${this.icon}"></i>
          ${item}
        </div>
      `).join('');

      // Add click handlers
      this.dropdown.querySelectorAll('.autocomplete-item').forEach(el => {
        el.addEventListener('click', () => {
          this.addItem(el.dataset.value);
        });
      });

      this.dropdown.classList.add('show');
    }

    addItem(item) {
      if (!this.selectedItems.includes(item)) {
        this.selectedItems.push(item);
        this.updateHidden();
        this.renderTags();
      }
      
      this.input.value = '';
      this.dropdown.classList.remove('show');
      this.input.focus();
    }

    removeItem(item) {
      this.selectedItems = this.selectedItems.filter(i => i !== item);
      this.updateHidden();
      this.renderTags();
    }

    updateHidden() {
      this.hiddenInput.value = this.selectedItems.join(', ');
    }

    renderTags() {
      if (this.selectedItems.length === 0) {
        this.tagsContainer.innerHTML = '<span class="text-muted small">Nie wybrano żadnych pozycji</span>';
        return;
      }

      this.tagsContainer.innerHTML = this.selectedItems.map(item => `
        <span class="selected-tag">
          <i class="bi ${this.icon}"></i>
          ${item}
          <span class="tag-remove" data-value="${item}">×</span>
        </span>
      `).join('');

      // Add remove handlers
      this.tagsContainer.querySelectorAll('.tag-remove').forEach(el => {
        el.addEventListener('click', () => {
          this.removeItem(el.dataset.value);
        });
      });
    }
  }

  // Initialize autocompletes
  const genresAutocomplete = new Autocomplete(
    'genres-search',
    'genres-dropdown',
    'genres-tags',
    'genres-hidden',
    allGenres,
    'bi-music-note'
  );

  const artistsAutocomplete = new Autocomplete(
    'artists-search',
    'artists-dropdown',
    'artists-tags',
    'artists-hidden',
    allArtists,
    'bi-person'
  );

  // Bio character counter
  const bioInput = document.getElementById('bio-input');
  const bioCount = document.getElementById('bio-count');
  
  if (bioInput && bioCount) {
    const updateBioCount = () => {
      bioCount.textContent = bioInput.value.length;
    };
    updateBioCount();
    bioInput.addEventListener('input', updateBioCount);
  }

  // Form validation on submit
  const form = document.querySelector('form');
  if (form) {
    form.addEventListener('submit', (e) => {
      const email = form.querySelector('[name="email"]');
      if (!email.value.trim()) {
        e.preventDefault();
        alert('Email jest wymagany');
        email.focus();
      }
    });
  }

  // Profile picture preview
  const pictureUpload = document.getElementById('picture-upload');
  const avatarPreview = document.getElementById('avatar-preview');
  const removeButton = document.getElementById('remove-picture');
  
  if (pictureUpload && avatarPreview) {
    pictureUpload.addEventListener('change', function(e) {
      const file = e.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
          avatarPreview.innerHTML = `<img src="${e.target.result}" alt="Preview" style="width: 100%; height: 100%; object-fit: cover; border-radius: 50%;">`;
        };
        reader.readAsDataURL(file);
      }
    });
  }

  if (removeButton) {
    removeButton.addEventListener('click', function() {
      if (confirm('Czy na pewno chcesz usunąć zdjęcie profilowe?')) {
        // Create hidden input to signal removal
        const input = document.createElement('input');
        input.type = 'hidden';
        input.name = 'remove_picture';
        input.value = 'true';
        document.querySelector('form').appendChild(input);
        document.querySelector('form').submit();
      }
    });
  }
})();
</script>

{% endblock %}