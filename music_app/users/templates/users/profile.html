
{% extends "users/base.html" %}
{% load static %}
{% block content %}

<!-- Profile Cover Section -->
<div class="profile-cover"></div>
<!-- Main Container -->
<div class="container" style="margin-top: -50px; position: relative; z-index: 10;">
  
  
  <!-- Profile Header -->
  <div class="profile-header-content">
    <img src="{% if user.profile_picture %}{{ user.profile_picture.url }}{% else %}https://ui-avatars.com/api/?name={{ user.username }}&background=2a2a2a&color=fff&size=280{% endif %}" 
         alt="{{ user.username }}" 
         class="profile-avatar">
    
    <div class="profile-info">
      <h1 class="profile-username">{{ user.username }}</h1>
      <div class="profile-meta">
        <i class="bi bi-calendar3"></i> Zarejestrowany: {{ user.date_joined|date:"d.m.Y" }}
        {% if user.city %}
          <span style="margin-left: 16px;">
            <i class="bi bi-geo-alt-fill"></i> {{ user.city }}
          </span>
        {% endif %}
      </div>
    </div>
  </div>
  <!-- Stats Grid -->
  <div class="stats-grid">
    <a href="{% url 'user_reviews' %}" style="text-decoration: none; color: inherit;">
      <div class="stat-card" style="cursor: pointer;">
        <div class="stat-icon" style="background: linear-gradient(135deg, #db2777, #ec4899);">
          <i class="bi bi-chat-left-text-fill"></i>
        </div>
        <div class="stat-value">{{ reviews_count }}</div>
        <div class="stat-label">Recenzji</div>
      </div>
    </a>
    <div class="stat-card">
      <div class="stat-icon" style="background: linear-gradient(135deg, #2563eb, #3b82f6);">
        <i class="bi bi-star-fill"></i>
      </div>
      <div class="stat-value">{{ average_rating|floatformat:1 }}</div>
      <div class="stat-label">Średnia ocen</div>
    </div>
    <a href="{% url 'user_favorites' %}" style="text-decoration: none; color: inherit;">
      <div class="stat-card" style="cursor: pointer;">
        <div class="stat-icon" style="background: linear-gradient(135deg, #7c3aed, #a855f7);">
          <i class="bi bi-heart-fill"></i>
        </div>
        <div class="stat-value">{{ favorites_count }}</div>
        <div class="stat-label">Ulubionych</div>
      </div>
    </a>
    <a href="{% url 'playlist_list' %}" style="text-decoration: none; color: inherit;">
      <div class="stat-card" style="cursor: pointer;">
        <div class="stat-icon" style="background: linear-gradient(135deg, #059669, #10b981);">
          <i class="bi bi-music-note-list"></i>
        </div>
        <div class="stat-value">{{ playlists_number }}</div>
        <div class="stat-label">Playlist</div>
      </div>
    </a>
    <a href="{% url 'followers_list' user.username %}" style="text-decoration: none; color: inherit;">
      <div class="stat-card" style="cursor: pointer;">
        <div class="stat-icon" style="background: linear-gradient(135deg, #f59e0b, #fbbf24);">
          <i class="bi bi-people-fill"></i>
        </div>
        <div class="stat-value">{{ followers_count }}</div>
        <div class="stat-label">Obserwujących</div>
      </div>
    </a>
    
    <a href="{% url 'following_list' user.username %}" style="text-decoration: none; color: inherit;">
      <div class="stat-card" style="cursor: pointer;">
        <div class="stat-icon" style="background: linear-gradient(135deg, #0891b2, #06b6d4);">
          <i class="bi bi-person-check-fill"></i>
        </div>
        <div class="stat-value">{{ following_count }}</div>
        <div class="stat-label">Obserwuje</div>
      </div>
    </a>
  </div>
  <!-- XP Progress Card -->
  <div class="xp-card">
    <div class="xp-header">
      <div class="level-badge">
        <i class="bi bi-lightning-fill" style="color: #fbbf24;"></i>
        <span>POZIOM {{ level }}</span>
      </div>
      <div class="d-flex align-items-center gap-3">
        <div class="badge-chip bdg-bronze">
          <i class="bi bi-trophy-fill"></i>
          <span>{{ badge_name|default:"Bronze" }}</span>
        </div>
        <div class="xp-stats">
          <div><strong>{{ level_in_xp|default:0 }}</strong> / 1000 XP</div>
          <div class="text-muted" style="font-size: 0.75rem;">: {{ to_next|default:0 }} do następnego poziomu</div>
        </div>
      </div>
    </div>
    <div class="position-relative mt-2">
        <!-- Трек прогресу -->
        <div class="xp-track" aria-label="Postęp poziomu"
             role="progressbar"
             aria-valuemin="0" aria-valuemax="100"
             aria-valuenow="{{ level_progress_pct|default:0 }}">
          <div class="xp-fill" id="xpFill"
               style="--xp-pct: 0%;"
               data-target="{{ level_progress_pct|default:0 }}%"></div>

          <!-- Тики кожні 10% -->
          <div class="xp-ticks">
            <span></span><span></span><span></span><span></span><span></span>
            <span></span><span></span><span></span><span></span>
          </div>

          <!-- Тултіп з поточним % -->
          <div class="xp-tooltip" id="xpTip" style="left: 0%"> {{ level_progress_pct|default:0 }}% </div>
        </div>

        <div class="xp-legend mt-2">
          <span>0%</span><span>25%</span><span>50%</span><span>75%</span><span>100%</span>
        </div>
      </div>
  </div>
  <!-- Two Column Layout: Activity Feed + Sidebar -->
  <div class="content-columns">
    
    <!-- Left Column: Recent Activity -->
    <div>
      <div class="section-header">
        <h2 class="section-title">
          <i class="bi bi-clock-history me-2"></i>
          Ostatnia aktywność
        </h2>
      </div>
      <div class="activity-feed">
        {% if recent_reviews %}
          {% for review in recent_reviews %}
            <div class="activity-item">
              <div class="cover">
                {% if review.track.cover_image %}
                  <img src="{{ review.track.cover_image }}" alt="{{ review.track.title }}" style="width: 100%; height: 100%; object-fit: cover; border-radius: 4px;">
                {% else %}
                  <img src="{% static 'img/Insony.jpg' %}" alt="Insony" style="width: 100%; height: 100%; object-fit: cover; border-radius: 4px;">
                {% endif %}
              </div>
              <div class="activity-content">
                <div class="activity-track">{{ review.track.title }}</div>
                <div class="activity-meta">
                  <span><i class="bi bi-calendar3"></i> {{ review.created_at|date:"d.m.Y H:i" }}</span>
                  <span class="activity-score">{{ review.total_percent|floatformat:1 }}%</span>
                </div>
              </div>
              <a href="{% url 'track_detail' review.track.id %}" class="btn-view">Szczegóły</a>
            </div>
          {% endfor %}
        {% else %}
          <div class="empty-state">
            <i class="bi bi-music-note-list"></i>
            <div>Brak recenzji</div>
            <small>Rozpocznij ocenianie utworów</small>
          </div>
        {% endif %}
      </div>
    </div>
    <!-- Right Column: Sidebar -->
    <div class="sidebar">
      
      <!-- Favorite Genres Card -->
      <div class="sidebar-card">
        <div class="sidebar-card-title">
          <i class="bi bi-music-note-beamed"></i>
          Ulubione gatunki
        </div>
        
        {% if favorite_genres_list %}
          <div class="tag-cloud">
            {% for genre in favorite_genres_list %}
              <span class="tag">{{ genre }}</span>
            {% endfor %}
          </div>
        {% else %}
          <div class="empty-state">
            <i class="bi bi-music-note-list"></i>
            <div>Brak ulubionych gatunków</div>
            <small>Dodaj gatunki w ustawieniach</small>
          </div>
        {% endif %}
      </div>
      <!-- Favorite Artists Card -->
      <div class="sidebar-card">
        <div class="sidebar-card-title">
          <i class="bi bi-people-fill"></i>
          Ulubieni artyści
        </div>
        
        {% if favorite_artists_list %}
          <div>
            {% for artist in favorite_artists_list %}
              <div class="artist-item">
                <div class="artist-avatar" style="background: linear-gradient(135deg, {% cycle '#dc2626, #f97316' '#2563eb, #7c3aed' '#059669, #10b981' '#7c3aed, #a855f7' '#db2777, #ec4899' %});">
                  {{ artist|slice:":2"|upper }}
                </div>
                <div class="artist-info">
                  <div class="artist-name">{{ artist }}</div>
                </div>
              </div>
            {% endfor %}
          </div>
        {% else %}
          <div class="empty-state">
            <i class="bi bi-person"></i>
            <div>Brak ulubionych artystów</div>
            <small>Rozpocznij ocenianie utworów</small>
          </div>
        {% endif %}
      </div>
      <!-- Bio/About Card (if user has bio) -->
      <div class="sidebar-card">
        <div class="sidebar-card-title">
          <i class="bi bi-person-badge"></i>
          O mnie
        </div>
        {% if user.bio %}
          <p style="color: #b6bdc6; font-size: 0.9rem; line-height: 1.6; margin: 0;">
            {{ user.bio }}
          </p>
        {% else %}
          <div class="empty-state" style="padding: 20px;">
            <i class="bi bi-chat-square-text" style="font-size: 32px;"></i>
            <div style="font-size: 0.875rem;">Brak opisu</div>
          </div>
        {% endif %}
      </div>
    </div>
  </div>
  <div style="height: 80px;"></div>
</div>

<script>
  // Animate XP bar on load
(function () {
  const fill = document.getElementById('xpFill');
  const tip  = document.getElementById('xpTip');
  if (!fill || !tip) return;

  // цільовий % із data-атрибуту
  const target = parseFloat(fill.dataset.target || '0');
  const clamp = v => Math.max(0, Math.min(100, v));

  // стартова анімація
  requestAnimationFrame(() => {
    fill.style.setProperty('--xp-pct', clamp(target) + '%');
    tip.textContent = Math.round(clamp(target)) + '%';
    tip.style.left  = clamp(target) + '%';
  });

  // якщо хочеш, щоб тултіп плавав при наведенні:
  fill.parentElement.addEventListener('mousemove', (e) => {
    const rect = e.currentTarget.getBoundingClientRect();
    const pct = clamp(((e.clientX - rect.left) / rect.width) * 100);
    tip.style.left = pct + '%';
  });

  
  document.getElementById('followersCount').textContent = '{{ followers_count }}';
  document.getElementById('followingCount').textContent = '{{ following_count }}';
})();
</script>

<script>
// Load follower counts
(async function() {
  try {
    const resp = await fetch('/users/u/{{ user.username }}/');
    // We'll need to pass these counts in context
  } catch(e) {}
})();
</script>

{% endblock %}