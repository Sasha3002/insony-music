{% extends "users/base.html" %}
{% load static %}

{% block extra_css %}
  <link rel="stylesheet" href="{% static 'css/groups.css' %}">
{% endblock %}

{% block content %}

<div class="container py-4">
  
  <a href="{% url 'group_list' %}" class="btn btn-outline-light mb-3">
    <i class="bi bi-arrow-left"></i> Powrót do grup
  </a>

  <div class="group-detail-header">
    <div class="group-cover-section">
      {% if group.cover_image %}
        <img src="{{ group.cover_image.url }}" alt="{{ group.name }}" class="group-cover-large">
      {% else %}
        <div class="group-cover-placeholder-large">
          <i class="bi bi-people"></i>
        </div>
      {% endif %}
    </div>

    <div class="group-info-section">
      <div class="group-title-row">
        <div>
          <h1 class="group-title">{{ group.name }}</h1>
          <div class="group-location-detail">
            <i class="bi bi-geo-alt-fill"></i>
            {{ group.location }}
          </div>
          <div class="group-admin-info">
            <i class="bi bi-person-badge"></i>
            Administrator: 
            <a href="{% url 'user_profile_public' group.admin.username %}">{{ group.admin.username }}</a>
            {% if is_admin %}<span style="color: #f59e0b;">(Ty)</span>{% endif %}
          </div>
        </div>

        <div class="group-actions">
          {% if is_admin %}
            <a href="{% url 'event_create' group.slug %}" class="btn-edit">
              <i class="bi bi-calendar-plus"></i> Utwórz wydarzenie
            </a>
            <a href="{% url 'group_chat' group.slug %}" class="btn-edit">
              <i class="bi bi-chat-dots"></i> Czat grupy
            </a>
            <a href="{% url 'group_edit' group.slug %}" class="btn-edit">
              <i class="bi bi-pencil"></i> Edytuj grupę
            </a>
            <a href="{% url 'group_delete' group.slug %}" class="btn-leave">
              <i class="bi bi-trash"></i> Usuń grupę
            </a>
          {% elif is_member %}
            <a href="{% url 'group_chat' group.slug %}" class="btn-edit">
              <i class="bi bi-chat-dots"></i> Czat grupy
            </a>
            <a href="{% url 'event_create' group.slug %}" class="btn-edit">
              <i class="bi bi-calendar-plus"></i> Utwórz wydarzenie
            </a>
            <form method="post" action="{% url 'group_leave' group.slug %}" style="display: inline;">
              {% csrf_token %}
              <button type="submit" class="btn-leave" onclick="return confirm('Czy na pewno chcesz opuścić grupę?')">
                <i class="bi bi-box-arrow-right"></i> Opuść grupę
              </button>
            </form>
          {% elif has_pending_request %}
            <button class="btn-pending" disabled>
              <i class="bi bi-clock"></i> Oczekuje na akceptację
            </button>
          {% else %}
            <form method="post" action="{% url 'group_join' group.slug %}" style="display: inline;">
              {% csrf_token %}
              <button type="submit" class="btn-join">
                <i class="bi bi-plus-circle"></i> 
                {% if group.type == 'public' %}Dołącz{% else %}Poproś o dołączenie{% endif %}
              </button>
            </form>
          {% endif %}
          
          {% if is_member %}
            <a href="{% url 'group_invite' group.slug %}" class="btn-edit">
              <i class="bi bi-person-plus"></i> Zaproś
            </a>
          {% endif %}
        </div>
      </div>

      {% if group.genres.all %}
        <div class="group-genres-section">
          {% for genre in group.genres.all %}
            <span class="genre-badge">
              <i class="bi bi-music-note"></i> {{ genre.name }}
            </span>
          {% endfor %}
        </div>
      {% endif %}
    </div>
  </div>

  <!-- Stats -->
  <div class="group-stats">
    <div class="stat-card">
      <div class="stat-value">{{ members|length }}</div>
      <div class="stat-label">Członków</div>
    </div>
    <div class="stat-card">
      <div class="stat-value">
        {% if group.type == 'public' %}
          <i class="bi bi-unlock stat-icon-public"></i>
        {% else %}
          <i class="bi bi-lock stat-icon-private"></i>
        {% endif %}
      </div>
      <div class="stat-label">
        {% if group.type == 'public' %}Grupa publiczna{% else %}Grupa prywatna{% endif %}
      </div>
    </div>
    <div class="stat-card">
      <div class="stat-value">{{ group.created_at|date:"d.m.Y" }}</div>
      <div class="stat-label">Data utworzenia</div>
    </div>
  </div>

  <!-- Description -->
  <div class="group-description-section">
    <h2 class="section-title">
      <i class="bi bi-info-circle"></i>
      O grupie
    </h2>
    <p class="group-description-text">{{ group.description|linebreaks }}</p>
  </div>

  <!-- Pending Requests (Admin Only) -->
  {% if is_admin and pending_requests %}
    <div class="pending-section">
      <h2 class="section-title">
        <i class="bi bi-clock-history"></i>
        Oczekujące prośby ({{ pending_requests|length }})
      </h2>
      {% for membership in pending_requests %}
        <div class="pending-card">
          <div class="member-avatar">
            {% if membership.user.profile_picture %}
              <img src="{{ membership.user.profile_picture.url }}" alt="{{ membership.user.username }}">
            {% else %}
              <div class="member-avatar-placeholder">
                {{ membership.user.username|slice:":1"|upper }}
              </div>
            {% endif %}
          </div>
          
          <div class="member-info">
            <div class="member-name">
              <a href="{% url 'user_profile_public' membership.user.username %}">
                {{ membership.user.username }}
              </a>
            </div>
            <div class="member-role">
              Prośba wysłana: {{ membership.joined_at|date:"d.m.Y H:i" }}
            </div>
          </div>

          <div class="pending-actions">
            <form method="post" action="{% url 'approve_member' group.slug membership.id %}" style="display: inline;">
              {% csrf_token %}
              <button type="submit" class="btn-approve">
                <i class="bi bi-check-circle"></i> Akceptuj
              </button>
            </form>
            <form method="post" action="{% url 'reject_member' group.slug membership.id %}" style="display: inline;">
              {% csrf_token %}
              <button type="submit" class="btn-reject">
                <i class="bi bi-x-circle"></i> Odrzuć
              </button>
            </form>
          </div>
        </div>
      {% endfor %}
    </div>
  {% endif %}

  <!-- Upcoming Events -->
  <div class="members-section">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h2 class="section-title mb-0">
        <i class="bi bi-calendar-event"></i>
        Nadchodzące wydarzenia
      </h2>
    </div>

    {% if upcoming_events %}
      {% for event in upcoming_events|slice:":3" %}
        <a href="{% url 'event_detail' event.slug %}" class="member-card">
          <div class="member-avatar">
            {% if event.event_image %}
              <img src="{{ event.event_image.url }}" alt="{{ event.title }}" class="event-image-avatar">
            {% else %}
              <div class="event-placeholder-avatar">
                <i class="bi bi-calendar-event"></i>
              </div>
            {% endif %}
          </div>

          <div class="member-info">
            <div class="member-name">{{ event.title }}</div>
            <div class="member-role">
              <i class="bi bi-clock"></i>
              {{ event.event_date|date:"d.m.Y, H:i" }}
              {% if event.end_date %}
                - {{ event.end_date|date:"H:i" }}
              {% endif %}
            </div>
            <div class="member-role">
              <i class="bi bi-geo-alt"></i>
              {{ event.location }}
            </div>
          </div>

          <div class="event-attendee-count">
            <i class="bi bi-people-fill"></i>
            {{ event.attendee_count }}
          </div>
        </a>
      {% endfor %}
      
      {% if upcoming_events|length > 3 %}
        <div class="view-all-link">
          <a href="{% url 'event_list' %}?filter=upcoming&group={{ group.slug }}" class="btn btn-outline-light">
            Zobacz wszystkie ({{ upcoming_events|length }})
          </a>
        </div>
      {% endif %}
    {% else %}
      <p class="empty-message">
        <i class="bi bi-calendar-x"></i>
        Brak nadchodzących wydarzeń
      </p>
    {% endif %}
  </div>

  <!-- Past Events -->
  {% if past_events %}
    <div class="members-section" style="margin-top: 32px;">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h2 class="section-title mb-0">
          <i class="bi bi-clock-history"></i>
          Archiwum wydarzeń
        </h2>
      </div>

      {% for event in past_events|slice:":3" %}
        <a href="{% url 'event_detail' event.slug %}" class="member-card event-card-past">
          <div class="member-avatar">
            {% if event.event_image %}
              <img src="{{ event.event_image.url }}" alt="{{ event.title }}" class="event-image-avatar event-image-avatar-past">
            {% else %}
              <div class="event-placeholder-avatar event-placeholder-avatar-past">
                <i class="bi bi-calendar-check"></i>
              </div>
            {% endif %}
          </div>

          <div class="member-info">
            <div class="member-name">{{ event.title }}</div>
            <div class="member-role">
              <i class="bi bi-clock"></i>
              {{ event.event_date|date:"d.m.Y, H:i" }}
              {% if event.end_date %}
                - {{ event.end_date|date:"H:i" }}
              {% endif %}
            </div>
            <div class="member-role">
              <i class="bi bi-geo-alt"></i>
              {{ event.location }}
            </div>
          </div>

          <div class="event-completed-badge">
            <i class="bi bi-check-circle"></i>
            Zakończone
          </div>
        </a>
      {% endfor %}
      
      {% if past_events|length > 3 %}
        <div class="view-all-link">
          <a href="{% url 'event_list' %}?filter=past&group={{ group.slug }}" class="btn btn-outline-light">
            Zobacz archiwum ({{ past_events|length }})
          </a>
        </div>
      {% endif %}
    </div>
  {% endif %}

  <!-- Members -->
  <div class="members-section">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h2 class="section-title mb-0">
        <i class="bi bi-people"></i>
        Członkowie ({{ members|length }})
      </h2>
      <a href="{% url 'group_members' group.slug %}" class="btn-edit">
        <i class="bi bi-eye"></i> Zobacz wszystkich
      </a>
    </div>

    {% for membership in members %}
      <div class="member-card">
        <div class="member-avatar">
          {% if membership.user.profile_picture %}
            <img src="{{ membership.user.profile_picture.url }}" alt="{{ membership.user.username }}">
          {% else %}
            <div class="member-avatar-placeholder">
              {{ membership.user.username|slice:":1"|upper }}
            </div>
          {% endif %}
        </div>
        
        <div class="member-info">
          <div class="member-name">
            <a href="{% url 'user_profile_public' membership.user.username %}">
              {{ membership.user.username }}
            </a>
          </div>
          <div class="member-role">
            Dołączył: {{ membership.joined_at|date:"d.m.Y" }}
          </div>
        </div>

        {% if membership.user == group.admin %}
          <span class="admin-badge">
            <i class="bi bi-star-fill"></i> Administrator
          </span>
        {% elif is_admin %}
          <form method="post" action="{% url 'remove_member' group.slug membership.user.id %}" style="display: inline;">
            {% csrf_token %}
            <button type="submit" class="btn-reject" onclick="return confirm('Czy na pewno chcesz usunąć {{ membership.user.username }} z grupy?')" title="Usuń z grupy">
              <i class="bi bi-x-circle"></i>
            </button>
          </form>
        {% endif %}
      </div>
    {% empty %}
      <p class="empty-message">
        Brak członków w grupie
      </p>
    {% endfor %}
  </div>

</div>

{% endblock %}
